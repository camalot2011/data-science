---
title: "stock_v1"
author: "Zhandi Liao"
date: "June 30, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Stock_checking function

This script is made to check the US stock market for the past three weeks trades. 

```{r dependency, eval=TRUE,echo=FALSE}
library(quantmod)
library(BatchGetSymbols)
library(tidyverse)
library(xlsx)
```

## Download the trade info in the past 3 months from Yahoo finance

```{r download,echo=FALSE}
# Getting the symbols for all the stocks
all_stock_info <- stockSymbols(exchange = c("AMEX","NASDAQ","NYSE"),
                               sort.by = c("Exchange","Symbol"),quiet = FALSE)
tickers <- all_stock_info$Symbol
# Download from Yahoo finance
start <- Sys.Date() - 90
end <- Sys.Date()
trades <- BatchGetSymbols(tickers = tickers,first.date = start, last.date = end, 
                          thresh.bad.data = 0.75,bench.ticker = "QQQ",do.complete.data = TRUE,
                          do.cache = TRUE,cache.folder = "~/BGS_Cache")
```

## Data processing: pick the price between $0.50 and $15.00, calculate the nearest three week boll bands, filter
## only the ones that fluctuate larger than 5%
```{r data_processing}
trades_processed <- trades$df.tickers %>% filter(price.adjusted > 0.5 & price.adjusted < 15) %>%
                    select(ticker,ref.date,price.high:price.close) %>%
                    mutate(price.typical = (price.high+price.low+price.close)/3)

ticker_processed <- unique(trades_processed$ticker)
ticker_boll <- data.frame()
ticker_picked <- c()
for (i in ticker_processed) {
    l <- trades_processed %>% filter(ticker == i)
    if (count(l)<62) next
    else {
      Boll <- BBands(l$price.typical,n=20,SMA,sd=2)
      l_boll <- l %>% mutate(BBands = Boll[,2],Bdn = Boll[,1], Bup = Boll[,3]) %>%
                select(ticker,BBands, Bdn, Bup)
      ticker_boll <- rbind(ticker_boll,l_boll)
      if ((max(l_boll$BBands[47:62])> 1.05*l_boll$BBands[47]) | (min(l_boll$BBands[47:62]) < 0.95*l_boll$BBands[47])) {
          ticker_picked <- c(ticker_picked,i)
      }
    }
}
```
## Merge data
```{r data_merging}
trades_processed_boll <- filter(trades_processed, trades_processed$ticker %in% ticker_picked)
ticker_boll_picked <- filter(ticker_boll,ticker_boll$ticker %in% ticker_picked)
trades_picked <- mutate(trades_processed_boll, BBands = ticker_boll_picked$BBands, Bdn = ticker_boll_picked$Bdn, Bup = ticker_boll_picked$Bup)

ticker_picked <- matrix(ticker_picked,ncol = 10, byrow = TRUE)
write.xlsx(ticker_picked,"./Stock_picked.xlsx")
```


